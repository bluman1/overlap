---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Team Members">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 800px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">← Back</a>
        <h1 style="font-size: 1.5rem;">Team Members</h1>
      </div>

      <div id="users-list" class="card">
        <p class="text-secondary">Loading...</p>
      </div>

      <!-- Toast for error messages -->
      <div id="toast" style="
        position: fixed;
        bottom: var(--space-lg);
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-elevated);
        border: 1px solid var(--accent-orange);
        color: var(--accent-orange);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        display: none;
        z-index: 1000;
      "></div>
    </div>
  </main>
</Layout>

<style>
  .users-table {
    width: 100%;
    border-collapse: collapse;
  }

  .users-table th {
    text-align: left;
    padding: var(--space-sm) var(--space-md);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border-default);
  }

  .users-table td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
  }

  .users-table tr:last-child td {
    border-bottom: none;
  }

  .user-name {
    font-weight: 500;
  }

  .user-email {
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  .role-badge {
    display: inline-block;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
  }

  .role-badge.admin {
    border-color: var(--accent-orange);
    color: var(--accent-orange);
  }

  .role-badge.member {
    color: var(--text-secondary);
  }

  .action-cell {
    text-align: right;
  }

  @media (max-width: 600px) {
    .users-table th:nth-child(2),
    .users-table td:nth-child(2) {
      display: none;
    }
  }
</style>

<script>
  type User = {
    id: string;
    name: string;
    email: string | null;
    role: 'admin' | 'member';
    is_active: boolean;
  };

  const toast = document.getElementById('toast') as HTMLDivElement;
  let isCurrentUserAdmin = false;

  function showToast(message: string) {
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 4000);
  }

  async function loadUsers() {
    const container = document.getElementById('users-list') as HTMLDivElement;

    try {
      const response = await fetch('/api/v1/admin/users');
      const result = await response.json() as { data?: { users: User[], is_admin: boolean }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to load users');
      }

      const users = result.data?.users || [];
      isCurrentUserAdmin = result.data?.is_admin || false;

      if (users.length === 0) {
        container.innerHTML = '<p class="text-secondary">No team members yet.</p>';
        return;
      }

      // Sort users: admins first, then by name
      const sortedUsers = [...users].sort((a, b) => {
        if (a.role === 'admin' && b.role !== 'admin') return -1;
        if (a.role !== 'admin' && b.role === 'admin') return 1;
        return a.name.localeCompare(b.name);
      });

      // Build table
      let html = `
        <table class="users-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              ${isCurrentUserAdmin ? '<th></th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;

      html += sortedUsers.map((user) => `
        <tr data-user-id="${user.id}">
          <td><span class="user-name">${user.name}</span></td>
          <td><span class="user-email">${user.email || '—'}</span></td>
          <td><span class="role-badge ${user.role}">${user.role}</span></td>
          ${isCurrentUserAdmin ? `
            <td class="action-cell">
              ${user.role === 'member'
                ? `<button class="btn btn-secondary" onclick="promoteUser('${user.id}', '${user.name}')" style="font-size: 0.75rem; padding: 4px 8px;">Promote</button>`
                : `<button class="btn btn-secondary" onclick="demoteUser('${user.id}', '${user.name}')" style="font-size: 0.75rem; padding: 4px 8px;">Demote</button>`
              }
            </td>
          ` : ''}
        </tr>
      `).join('');

      html += '</tbody></table>';

      // Add info message for non-admins
      if (!isCurrentUserAdmin) {
        html += `
          <div style="
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            text-align: center;
          ">
            <p class="text-secondary" style="font-size: 0.875rem; margin: 0;">
              Only admins can manage team members.<br/>
              Contact your team admin if you need changes.
            </p>
          </div>
        `;
      }

      container.innerHTML = html;
    } catch (error) {
      container.innerHTML = `<p style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load users'}</p>`;
    }
  }

  async function promoteUser(userId: string, userName: string) {
    if (!confirm(`Promote ${userName} to admin?`)) return;

    try {
      const response = await fetch(`/api/v1/admin/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: 'admin' }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to promote user');
      }

      loadUsers();
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to promote user');
    }
  }

  async function demoteUser(userId: string, userName: string) {
    if (!confirm(`Demote ${userName} to member?`)) return;

    try {
      const response = await fetch(`/api/v1/admin/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: 'member' }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to demote user');
      }

      loadUsers();
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to demote user');
    }
  }

  // Make functions global
  (window as unknown as { promoteUser: typeof promoteUser }).promoteUser = promoteUser;
  (window as unknown as { demoteUser: typeof demoteUser }).demoteUser = demoteUser;

  // Load users on page load
  loadUsers();
</script>
