---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Team Members">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 800px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem;">Team Members</h1>
      </div>

      <div id="users-list">
        <p class="text-secondary">Loading...</p>
      </div>

      <!-- Toast for messages -->
      <div id="toast" style="
        position: fixed;
        bottom: var(--space-lg);
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-elevated);
        border: 1px solid var(--accent-orange);
        color: var(--accent-orange);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        display: none;
        z-index: 1000;
      "></div>
    </div>
  </main>
</Layout>

<style>
  .user-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-sm);
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: var(--space-lg);
    align-items: center;
  }

  .user-card:last-of-type {
    margin-bottom: 0;
  }

  .user-info {
    min-width: 0;
  }

  .user-name {
    font-weight: 500;
    margin-bottom: 2px;
  }

  .user-email {
    color: var(--text-secondary);
    font-size: 0.875rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .role-badge {
    display: inline-block;
    font-size: 0.75rem;
    padding: 4px 12px;
    border-radius: var(--radius-sm);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    text-transform: capitalize;
  }

  .role-badge.admin {
    border-color: var(--accent-orange);
    color: var(--accent-orange);
  }

  .role-badge.member {
    color: var(--text-secondary);
  }

  .user-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .action-btn {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-default);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .action-btn:hover {
    border-color: var(--text-secondary);
    color: var(--text-primary);
  }

  .action-btn.danger {
    color: var(--accent-orange);
  }

  .action-btn.danger:hover {
    border-color: var(--accent-orange);
    background: rgba(255, 152, 0, 0.1);
  }

  .section-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
    padding-left: var(--space-sm);
  }

  .users-section {
    margin-bottom: var(--space-xl);
  }

  .users-section:last-child {
    margin-bottom: 0;
  }

  @media (max-width: 600px) {
    .user-card {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }

    .user-actions {
      justify-content: flex-start;
    }
  }
</style>

<script>
  type User = {
    id: string;
    name: string;
    email: string | null;
    role: 'admin' | 'member';
    is_active: boolean;
  };

  const toast = document.getElementById('toast') as HTMLDivElement;
  let isCurrentUserAdmin = false;
  let currentUserId = '';

  function showToast(message: string, isError = true) {
    toast.textContent = message;
    toast.style.borderColor = isError ? 'var(--accent-orange)' : 'var(--accent-green)';
    toast.style.color = isError ? 'var(--accent-orange)' : 'var(--accent-green)';
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 4000);
  }

  async function loadUsers() {
    const container = document.getElementById('users-list') as HTMLDivElement;

    try {
      const response = await fetch('/api/v1/admin/users');
      const result = await response.json() as { data?: { users: User[], is_admin: boolean, current_user_id?: string }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to load users');
      }

      const users = result.data?.users || [];
      isCurrentUserAdmin = result.data?.is_admin || false;
      currentUserId = result.data?.current_user_id || '';

      if (users.length === 0) {
        container.innerHTML = '<p class="text-secondary">No team members yet.</p>';
        return;
      }

      // Separate admins and members
      const admins = users.filter(u => u.role === 'admin').sort((a, b) => a.name.localeCompare(b.name));
      const members = users.filter(u => u.role === 'member').sort((a, b) => a.name.localeCompare(b.name));

      let html = '';

      // Admins section
      if (admins.length > 0) {
        html += `
          <div class="users-section">
            <div class="section-label">Admins (${admins.length})</div>
            ${admins.map(user => renderUserCard(user)).join('')}
          </div>
        `;
      }

      // Members section
      if (members.length > 0) {
        html += `
          <div class="users-section">
            <div class="section-label">Members (${members.length})</div>
            ${members.map(user => renderUserCard(user)).join('')}
          </div>
        `;
      }

      // Add info message for non-admins
      if (!isCurrentUserAdmin) {
        html += `
          <div style="
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            text-align: center;
          ">
            <p class="text-secondary" style="font-size: 0.875rem; margin: 0;">
              Only admins can manage team members.<br/>
              Contact your team admin if you need changes.
            </p>
          </div>
        `;
      }

      container.innerHTML = html;
    } catch (error) {
      container.innerHTML = `<p style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load users'}</p>`;
    }
  }

  function renderUserCard(user: User): string {
    const isSelf = user.id === currentUserId;

    let actionsHtml = '';
    if (isCurrentUserAdmin) {
      const buttons: string[] = [];

      if (user.role === 'member') {
        buttons.push(`<button class="action-btn" onclick="promoteUser('${user.id}', '${user.name}')">Promote</button>`);
      } else if (!isSelf) {
        buttons.push(`<button class="action-btn" onclick="demoteUser('${user.id}', '${user.name}')">Demote</button>`);
      }

      if (!isSelf) {
        buttons.push(`<button class="action-btn danger" onclick="removeUser('${user.id}', '${user.name}')">Remove</button>`);
      }

      if (buttons.length > 0) {
        actionsHtml = `<div class="user-actions">${buttons.join('')}</div>`;
      }
    }

    return `
      <div class="user-card" data-user-id="${user.id}">
        <div class="user-info">
          <div class="user-name">${user.name}${isSelf ? ' (you)' : ''}</div>
          <div class="user-email">${user.email || 'No email'}</div>
        </div>
        <span class="role-badge ${user.role}">${user.role}</span>
        ${actionsHtml}
      </div>
    `;
  }

  async function promoteUser(userId: string, userName: string) {
    if (!confirm(`Promote ${userName} to admin?`)) return;

    try {
      const response = await fetch(`/api/v1/admin/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: 'admin' }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to promote user');
      }

      showToast(`${userName} promoted to admin`, false);
      loadUsers();
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to promote user');
    }
  }

  async function demoteUser(userId: string, userName: string) {
    if (!confirm(`Demote ${userName} to member?`)) return;

    try {
      const response = await fetch(`/api/v1/admin/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: 'member' }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to demote user');
      }

      showToast(`${userName} demoted to member`, false);
      loadUsers();
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to demote user');
    }
  }

  async function removeUser(userId: string, userName: string) {
    if (!confirm(`Remove ${userName} from the team?\n\nThey will need to rejoin using the team invite link.`)) return;

    try {
      const response = await fetch(`/api/v1/admin/users/${userId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to remove user');
      }

      showToast(`${userName} removed from team`, false);
      loadUsers();
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to remove user');
    }
  }

  // Make functions global
  (window as unknown as { promoteUser: typeof promoteUser }).promoteUser = promoteUser;
  (window as unknown as { demoteUser: typeof demoteUser }).demoteUser = demoteUser;
  (window as unknown as { removeUser: typeof removeUser }).removeUser = removeUser;

  // Load users on page load
  loadUsers();
</script>
